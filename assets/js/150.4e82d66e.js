(window.webpackJsonp=window.webpackJsonp||[]).push([[150],{540:function(s,a,t){"use strict";t.r(a);var e=t(0),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("公司更换了新的服务器, 需要把原先的 gitlab 迁移到新的服务器上。")]),s._v(" "),a("h2",{attrs:{id:"_1-迁移准备工作和思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-迁移准备工作和思路"}},[s._v("#")]),s._v(" 1. 迁移准备工作和思路:")]),s._v(" "),a("p",[s._v("从 a 服务器迁移到 b 服务器, 由于 Gitlab 自身的兼容性问题，高版本的 Gitlab 无法恢复低版本备份的数据, 需要注意在 b 服务器部署和 a 服务器一样版本的 gitlab, 部署好环境后开始备份和数据迁移.")]),s._v(" "),a("p",[s._v("查看 gitlab 版本的命令:")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v(" gitlab-rake gitlab:env:info\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"_2-备份原-a-服务器上的的数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-备份原-a-服务器上的的数据"}},[s._v("#")]),s._v(" 2. 备份原 a 服务器上的的数据")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("gitlab-rake gitlab:backup:create "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RAILS_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("production\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("PS")]),s._v(": 备份后的文件一般是位于 / var/opt/gitlab/backups 下, 自动生成文件名文件名如 1481529483_gitlab_backup.tar")]),s._v(" "),a("h2",{attrs:{id:"_3-将步骤-2-生成的-tar-文件拷贝到-b-服务器上相应的-backups-目录下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-将步骤-2-生成的-tar-文件拷贝到-b-服务器上相应的-backups-目录下"}},[s._v("#")]),s._v(" 3. 将步骤 2 生成的 tar 文件拷贝到 b 服务器上相应的 backups 目录下")]),s._v(" "),a("p",[s._v("可以利用 scp 进行直接拷贝.")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" username@src_ip:/var/opt/gitlab/backups/1481529483_gitlab_backup.tar /var/opt/gitlab/backups  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("PS")]),s._v(": username 为原服务器的用户名，src_ip 原服务器 IP 地址")]),s._v(" "),a("h2",{attrs:{id:"_4-在-b-服务器恢复数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-在-b-服务器恢复数据"}},[s._v("#")]),s._v(" 4. 在 b 服务器恢复数据")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("gitlab-rake gitlab:backup:restore "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RAILS_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("production "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BACKUP")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/opt/gitlab/backups/1511876879_2017_11_28_10.1.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/6a6550e2aa820412.jpg",alt:"image"}})]),s._v(" "),a("p",[a("code",[s._v("PS")]),s._v("：BACKUP 的时间点必须与原服务器备份后的文件名一致")]),s._v(" "),a("p",[a("code",[s._v("PPS")]),s._v("：一般备份出来的名字是这样的，命令使用格式是 git 前边的数据就行")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/1f40764cc2ed240a.jpg",alt:"image"}})]),s._v(" "),a("p",[s._v("OK，恢复成功！")]),s._v(" "),a("h2",{attrs:{id:"_5-通过脚本定时备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-通过脚本定时备份"}},[s._v("#")]),s._v(" 5. 通过脚本定时备份")]),s._v(" "),a("p",[s._v("写一个简单的脚本，加入到定时任务，以保证每天备份一次代码到异地。")]),s._v(" "),a("p",[s._v("写脚本之前，先创建一下对应的工作目录：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ mkdir /backup\n$ touch /backup/logfile.txt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("脚本内容如下：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Bakupdir")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/opt/gitlab/backups/\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Logfile")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/backup/logfile.txt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Date")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%Y-%m-%d"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\ngitlab-rake gitlab:backup:create "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RAILS_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("production\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v(" -eq "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Date")]),s._v(' Backup Successful"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Logfile")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Date")]),s._v(' Backup Failed"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Logfile")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Bakupdir")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" *.tar backup@192.168.106.222:/home/backup/gitbak\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf *\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("然后将脚本加入定时任务，根据需求，定期执行即可！")]),s._v(" "),a("h2",{attrs:{id:"_6-出错解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-出错解决"}},[s._v("#")]),s._v(" 6. 出错解决")]),s._v(" "),a("p",[s._v("数据迁移到后检查登录 gialab 有时候会跳出 500 报错 (Something went wrong on our end.) 以及无法正常新建用户")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("查看日志: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" -f /var/log/gitlab/redis/current\nCan’t save "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" background: fork: Cannot allocate memory\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("解决方案")]),s._v(" "),a("p",[s._v("修改 "),a("code",[s._v("/ etc/sysctl.conf")])]),s._v(" "),a("p",[s._v("加上 "),a("code",[s._v("vm.overcommit_memory = 1")]),s._v(", Linux 内核会根据参数 vm.overcommit_memory 参数的设置决定是否放行。")]),s._v(" "),a("p",[s._v("修改完执行 "),a("code",[s._v("sysctl -p")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("vm.overcommit_memory "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("，直接放行\nvm.overcommit_memory "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("：则比较 此次请求分配的虚拟内存大小和系统当前空闲的物理内存加上 swap，决定是否放行。\nvm.overcommit_memory "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：则会比较进程所有已分配的虚拟内存加上此次请求分配的虚拟内\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("参考网址：http://wenva.github.io/git/2016/04/22/Gitlab%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%81%E7%A7%BB.html")])])}),[],!1,null,null,null);a.default=r.exports}}]);